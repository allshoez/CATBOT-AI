<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
<title>CatBot PWA</title>
<style>
:root{
  --wa-green:#075e54;
  --bg:#ece5dd;
  --me:#dcf8c6;
  --other:#fff;
}
body { margin:0; font-family: Segoe UI, sans-serif; background: var(--bg); font-size: 18px; }
header {
  display:flex; align-items:center; justify-content:space-between;
  background: var(--wa-green); color:#fff; padding:10px 12px;
  position:sticky; top:0; z-index:10;
}
.left { display:flex; align-items:center; gap:10px }
header img { width:40px; height:40px; border-radius:50% }
.title b { display:block; font-size:16px }
.title small { opacity:.8 }
.actions { display:flex; align-items:center; gap:8px }
.chip { font-size:12px; padding:6px 10px; border-radius:999px; background:#ffffff26; cursor:pointer }
.fab { background:none; border:none; color:#fff; font-size:22px; cursor:pointer }
#chat { padding:12px; min-height: calc(100vh - 120px); display:flex; flex-direction:column; gap:8px; overflow-y:auto; }
.msg {
  max-width:80%; padding:10px 12px; border-radius:10px; box-shadow:0 1px 1px #0001;
  word-wrap:break-word; position:relative; font-size:18px; white-space: pre-line; line-height: 1.6;
}
.user { align-self:flex-end; background:var(--me); border-top-right-radius:4px }
.bot { align-self:flex-start; background:var(--other); border-top-left-radius:4px }
.copyBtn {
  position: absolute; top: 4px; right: 4px; background: none; border: none;
  font-size: 14px; cursor: pointer; opacity: 0; transition: opacity .2s;
}
.msg:hover .copyBtn { opacity:0.7 }
.msg:hover .copyBtn:hover { opacity:1 }
footer { position:sticky; bottom:0; background:#fff; border-top:1px solid #0001; padding:10px; }
.row { display:flex; gap:8px; align-items:center }
#prompt { flex:1; resize:none; height:42px; padding:10px; border:1px solid #0002; border-radius:22px; font-size:18px; }
.send { background:var(--wa-green); color:#fff; border:none; border-radius:50%; width:42px; height:42px; cursor:pointer; }
.clear { background:#eee; border:none; border-radius:50px; padding:0 12px; font-size:13px; cursor:pointer }
.menu-popup { position:absolute; top:50px; right:10px; background:#fff; border:1px solid #ccc; border-radius:5px; display:none; flex-direction:column; min-width:150px; z-index:1002; }
.menu-popup.show { display:flex; }
.menu-popup button, .menu-popup label { padding:10px; text-align:left; border:none; background:none; width:100%; cursor:pointer; font-size:16px; color:#000; }
.menu-popup button:hover, .menu-popup label:hover { background:#f0f0f0; }
#modalJawab, #modalEditJawab, #modalAllRules {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1003;
}
#modalJawab > div, #modalEditJawab > div, #modalAllRules > div {
  background:#fff; padding:20px; border-radius:10px; width:90%; max-width:500px;
  display:flex; flex-direction:column; box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<header>
  <div class="left">
    <img src="https://i.pravatar.cc/100?img=47" alt="cewe">
    <div class="title"><b>CatBot</b><small id="status">online</small></div>
  </div>
  <span onclick="toggleMenu()">‚ãÆ</span>
  <div id="menuPopup" class="menu-popup">
    <label>Upload Data
      <input type="file" accept="application/json" onchange="uploadData(event)" style="display:none;">
    </label>
    <button onclick="downloadData()">Download Data</button>
    <button onclick="bukaModalAllRules()">Edit Data</button>
  </div>
  <div class="actions">
    <span id="providerBadge" class="chip">CatBot</span>
    <button id="openPopup" class="fab">+</button>
  </div>
</header>
<main id="chat"></main>
<footer>
  <div class="row">
    <button id="btnClear" class="clear">=</button>
    <textarea id="prompt" placeholder="Tulis pesan"></textarea>
    <button id="btnSend" class="send">‚û§</button>
  </div>
</footer>

<!-- Modal Tambah Jawaban -->
<div id="modalJawab">
  <div>
    <h3>Jawaban Baru</h3>
    <p id="pertanyaanBaru" style="font-style:italic"></p>
    <textarea id="inputJawabanBaru" placeholder="Tulis jawaban..."></textarea>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
      <button onclick="simpanJawabanBaru()" style="background:#075e54; color:#fff; border:none; padding:8px 15px; border-radius:5px;">Simpan</button>
      <button onclick="tutupModal()" style="background:#ccc; border:none; padding:8px 15px; border-radius:5px;">Batal</button>
    </div>
  </div>
</div>

<!-- Modal Edit Jawaban -->
<div id="modalEditJawab">
  <div>
    <h3>Edit Jawaban untuk: <span id="pertanyaanEdit"></span></h3>
    <ul id="listJawaban" style="max-height:200px; overflow-y:auto; padding-left:20px"></ul>
    <input id="inputJawabanEdit" placeholder="Tambah jawaban baru..."/>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
      <button onclick="tambahJawabanEdit()" style="background:#075e54; color:#fff; border:none; padding:8px 15px; border-radius:5px;">Tambah</button>
      <button onclick="tutupModalEdit()" style="background:#ccc; border:none; padding:8px 15px; border-radius:5px;">Tutup</button>
    </div>
  </div>
</div>

<!-- Modal Edit Semua Rules -->
<div id="modalAllRules">
  <div>
    <h3>Edit Semua Data Rules</h3>
    <textarea id="rulesTextarea" style="width:100%; height:300px; font-family:monospace;"></textarea>
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
      <button onclick="simpanSemuaRules()" style="background:#075e54; color:#fff; border:none; padding:8px 15px; border-radius:5px;">Simpan</button>
      <button onclick="tutupModalAllRules()" style="background:#ccc; border:none; padding:8px 15px; border-radius:5px;">Tutup</button>
    </div>
  </div>
</div>
<script src="script.js"></script>

<script>
let pertanyaanAktif = "";
function tampilkanPesan(sender, teks) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "msg " + sender;
  div.innerHTML = `${teks}<button class="copyBtn" onclick="navigator.clipboard.writeText(\`${teks}\`)">üìã</button>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function updateProviderBadge() {
  const provider = localStorage.getItem("provider") || "local";
  document.getElementById("providerBadge").innerText =
    provider === "local" ? "CatBot" : provider.charAt(0).toUpperCase() + provider.slice(1);
}
async function sendMessage(msg) {
  const provider = localStorage.getItem("provider") || "local";
  tampilkanPesan("user", msg);
  if (provider === "local") {
    let rules = JSON.parse(localStorage.getItem("botRules") || "[]");
    let rule = rules.find(r => r.Tanya.toLowerCase() === msg.toLowerCase());
    if (rule) {
      tampilkanPesan("bot", rule.Jawab[Math.floor(Math.random() * rule.Jawab.length)]);
    } else {
      tampilkanPesan("bot", "Apa jawabannya?");
      bukaModalJawab(msg);
    }
    return;
  }
  if (provider === "gemini") {
    tampilkanPesan("bot", "‚è≥ Tunggu jawaban Gemini...");
    return;
  }
  if (provider === "openai") {
    tampilkanPesan("bot", "‚è≥ Tunggu jawaban OpenAI...");
    return;
  }
}
// Modal Jawaban Baru
function bukaModalJawab(pertanyaan) {
  pertanyaanAktif = pertanyaan;
  document.getElementById("pertanyaanBaru").innerText = pertanyaan;
  document.getElementById("inputJawabanBaru").value = "";
  document.getElementById("modalJawab").style.display = "flex";
}
function tutupModal() {
  document.getElementById("modalJawab").style.display = "none";
}
function simpanJawabanBaru() {
  const jawaban = document.getElementById("inputJawabanBaru").value.trim();
  if (!jawaban) { alert("Jawaban tidak boleh kosong!"); return; }
  let rules = JSON.parse(localStorage.getItem("botRules") || "[]");
  let rule = rules.find(r => r.Tanya === pertanyaanAktif);
  if (rule) { rule.Jawab.push(jawaban); }
  else { rules.push({ Tanya: pertanyaanAktif, Jawab: [jawaban] }); }
  localStorage.setItem("botRules", JSON.stringify(rules));
  tutupModal();
  tampilkanPesan("bot", jawaban);
}
// Modal Edit Jawaban
function bukaModalEdit(pertanyaan) {
  pertanyaanAktif = pertanyaan;
  document.getElementById("pertanyaanEdit").innerText = pertanyaan;
  let rules = JSON.parse(localStorage.getItem("botRules") || "[]");
  let rule = rules.find(r => r.Tanya === pertanyaan);
  let list = document.getElementById("listJawaban");
  list.innerHTML = "";
  if (rule) {
    rule.Jawab.forEach((j, idx) => {
      let li = document.createElement("li");
      li.innerHTML = `${j} <button onclick="hapusJawaban(${idx})" style="margin-left:10px; font-size:12px;">‚ùå</button>`;
      list.appendChild(li);
    });
  }
  document.getElementById("modalEditJawab").style.display = "flex";
}
function tambahJawabanEdit() {
  const jawaban = document.getElementById("inputJawabanEdit").value.trim();
  if (!jawaban) return;
  let rules = JSON.parse(localStorage.getItem("botRules") || "[]");
  let rule = rules.find(r => r.Tanya === pertanyaanAktif);
  if (rule) { rule.Jawab.push(jawaban); }
  localStorage.setItem("botRules", JSON.stringify(rules));
  document.getElementById("inputJawabanEdit").value = "";
  bukaModalEdit(pertanyaanAktif);
}
function hapusJawaban(idx) {
  let rules = JSON.parse(localStorage.getItem("botRules") || "[]");
  let rule = rules.find(r => r.Tanya === pertanyaanAktif);
  if (rule) {
    rule.Jawab.splice(idx, 1);
    localStorage.setItem("botRules", JSON.stringify(rules));
    bukaModalEdit(pertanyaanAktif);
  }
}
function tutupModalEdit() {
  document.getElementById("modalEditJawab").style.display = "none";
}
// Modal Semua Rules
function bukaModalAllRules() {
  let rules = JSON.parse(localStorage.getItem("botRules") || "[]");
  document.getElementById("rulesTextarea").value = JSON.stringify(rules, null, 2);
  document.getElementById("modalAllRules").style.display = "flex";
}
function tutupModalAllRules() {
  document.getElementById("modalAllRules").style.display = "none";
}
function simpanSemuaRules() {
  try {
    let data = JSON.parse(document.getElementById("rulesTextarea").value);
    localStorage.setItem("botRules", JSON.stringify(data));
    alert("‚úÖ Rules berhasil disimpan");
    tutupModalAllRules();
  } catch(e) { alert("‚ùå Format JSON salah!"); }
}
// Menu
function toggleMenu() { document.getElementById("menuPopup").classList.toggle("show"); }
document.addEventListener("click", e => {
  const menu = document.getElementById("menuPopup");
  const tombol = e.target.closest("header span");
  if (!tombol && !menu.contains(e.target)) { menu.classList.remove("show"); }
});
// Event
document.getElementById("btnSend").addEventListener("click", () => {
  const txt = document.getElementById("prompt").value.trim();
  if (txt) { document.getElementById("prompt").value = ""; sendMessage(txt); }
});
updateProviderBadge();
</script>
</body>
</html>