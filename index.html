<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
<title>CatBot PWA</title>
<style>
:root {
  --wa-green:#075e54;
  --bg:#ece5dd;
  --me:#dcf8c6;
  --other:#fff;
}
body { margin:0; font-family: Segoe UI, sans-serif; background: var(--bg); font-size: 16px; }
header {
  display:flex; align-items:center; justify-content:space-between;
  background: var(--wa-green); color:#fff; padding:10px 12px;
  position:sticky; top:0; z-index:10;
}
.left { display:flex; align-items:center; gap:10px }
header img { width:40px; height:40px; border-radius:50% }
.title b { display:block; font-size:16px }
.title small { opacity:.8 }
.actions { display:flex; align-items:center; gap:8px }
.chip { font-size:12px; padding:6px 10px; border-radius:999px; background:#ffffff26; cursor:pointer }
.fab { background:none; border:none; color:#fff; font-size:22px; cursor:pointer }

/* Chat */
#chat { padding:12px; min-height: calc(100vh - 120px); display:flex; flex-direction:column; gap:8px; overflow-y:auto; }
.msg { max-width:80%; padding:10px 12px; border-radius:10px; box-shadow:0 1px 1px #0001; word-wrap:break-word; position:relative; font-size:16px; white-space: pre-line; line-height:1.5; }
.user { align-self:flex-end; background:var(--me); border-top-right-radius:4px }
.bot { align-self:flex-start; background:var(--other); border-top-left-radius:4px }
.copyBtn { position:absolute; top:4px; right:4px; background:none; border:none; font-size:14px; cursor:pointer; opacity:0; transition:opacity .2s; }
.msg:hover .copyBtn { opacity:0.7 }

/* Footer */
footer { position:sticky; bottom:0; background:#fff; border-top:1px solid #0001; padding:10px; }
.row { display:flex; gap:8px; align-items:center }
#prompt { flex:1; resize:none; height:42px; padding:10px; border:1px solid #0002; border-radius:22px; font-size:16px; }
.send { background:var(--wa-green); color:#fff; border:none; border-radius:50%; width:42px; height:42px; cursor:pointer; }
.clear { background:#eee; border:none; border-radius:50px; padding:0 12px; font-size:13px; cursor:pointer }

/* Menu Popup */
.menu-popup { position:absolute; top:50px; right:10px; background:#fff; border:1px solid #ccc; border-radius:5px; display:none; flex-direction:column; min-width:150px; z-index:1002; }
.menu-popup.show { display:flex; }
.menu-popup button, .menu-popup label { padding:10px; text-align:left; border:none; background:none; width:100%; cursor:pointer; font-size:14px; color:#000; }
.menu-popup button:hover, .menu-popup label:hover { background:#f0f0f0; }

/* Modal */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000; }
.modal > div { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; position:relative; }
.modal h3 { margin-top:0; }
</style>
</head>

<body>
<header>
  <div class="left">
    <img src="https://i.pravatar.cc/100?img=47" alt="cewe">
    <div class="title"><b>CatBot</b><small id="status">online</small></div>
  </div>
  <span onclick="toggleMenu()">‚ãÆ</span>
  <div id="menuPopup" class="menu-popup">
    <label>Upload Data
      <input type="file" accept="application/json" onchange="uploadData(event)" style="display:none;">
    </label>
    <button onclick="downloadData()">Download Data</button>
    <button onclick="openEditData()">Edit Data</button>
    <button onclick="openSettings()">Pengaturan API</button>
  </div>
  <div class="actions">
    <span id="providerBadge" class="chip">Local</span>
    <button id="openPopup" class="fab">+</button>
  </div>
</header>

<main id="chat"></main>

<footer>
  <div class="row">
    <button id="btnClear" class="clear">=</button>
    <textarea id="prompt" placeholder="Tulis pesan"></textarea>
    <button id="btnSend" class="send">‚û§</button>
  </div>
</footer>

<!-- Modal Edit Rules -->
<div id="modalEdit" class="modal">
  <div>
    <h3>Edit Rules</h3>
    <textarea id="editArea" style="width:100%;height:200px;"></textarea>
    <div style="margin-top:10px; text-align:right;">
      <button onclick="saveRules()">Simpan</button>
      <button onclick="closeModal('modalEdit')">Tutup</button>
    </div>
  </div>
</div>

<!-- Modal Settings -->
<div id="modalSettings" class="modal">
  <div>
    <button onclick="closeModal('modalSettings')" style="position:absolute;top:10px;right:10px;border:none;background:none;font-size:20px;cursor:pointer">‚úñ</button>
    <h3>‚öôÔ∏è Pengaturan API</h3>

    <label>Provider:</label>
    <select id="providerSel" style="width:100%; padding:8px; margin-bottom:10px;">
      <option value="local">Local (Rules)</option>
      <option value="gemini">Gemini</option>
      <option value="openai">OpenAI</option>
    </select>

    <label>System Prompt:</label>
    <textarea id="systemPrompt" style="width:100%;height:60px;margin-bottom:10px;"></textarea>

    <h4>üîë Gemini</h4>
    <input id="geminiKey" placeholder="API Key Gemini" style="width:100%;padding:8px;margin-bottom:6px;">
    <input id="geminiModel" value="gemini-1.5-flash" style="width:100%;padding:8px;margin-bottom:6px;">
    <input id="gemTemp" type="number" value="1" step="0.1" style="width:100%;padding:8px;margin-bottom:10px;">

    <h4>üîë OpenAI</h4>
    <input id="openaiKey" placeholder="API Key OpenAI" style="width:100%;padding:8px;margin-bottom:6px;">
    <input id="openaiModel" value="gpt-4o-mini" style="width:100%;padding:8px;margin-bottom:6px;">
    <input id="oaTemp" type="number" value="1" step="0.1" style="width:100%;padding:8px;margin-bottom:10px;">

    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="btnSave">Simpan</button>
    </div>
  </div>
</div>

<script>
let rules = JSON.parse(localStorage.getItem("botRules") || "[]");
let provider = localStorage.getItem("provider") || "local";

// UI
function addMessage(txt, who="bot"){
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.innerHTML = txt;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function toggleMenu(){ document.getElementById("menuPopup").classList.toggle("show"); }
function closeModal(id){ document.getElementById(id).style.display="none"; }
function openEditData(){
  document.getElementById("editArea").value = JSON.stringify(rules, null, 2);
  document.getElementById("modalEdit").style.display="flex";
}
function saveRules(){
  try{
    rules = JSON.parse(document.getElementById("editArea").value);
    localStorage.setItem("botRules", JSON.stringify(rules));
    closeModal("modalEdit");
    alert("Rules tersimpan!");
  }catch(e){ alert("Format JSON salah!"); }
}
function openSettings(){
  document.getElementById("providerSel").value = provider;
  document.getElementById("systemPrompt").value = localStorage.getItem("systemPrompt")||"";
  document.getElementById("geminiKey").value = localStorage.getItem("geminiKey")||"";
  document.getElementById("openaiKey").value = localStorage.getItem("openaiKey")||"";
  document.getElementById("modalSettings").style.display="flex";
}
document.getElementById("btnSave").onclick = ()=>{
  provider = document.getElementById("providerSel").value;
  localStorage.setItem("provider", provider);
  localStorage.setItem("systemPrompt", document.getElementById("systemPrompt").value);
  localStorage.setItem("geminiKey", document.getElementById("geminiKey").value);
  localStorage.setItem("openaiKey", document.getElementById("openaiKey").value);
  document.getElementById("providerBadge").innerText = provider;
  closeModal("modalSettings");
};

// Chat logic
function sendMessage(txt){
  addMessage(txt,"user");
  if(provider==="local"){
    let found = rules.find(r=>r.Tanya.toLowerCase()===txt.toLowerCase());
    if(found){
      let jawab = Array.isArray(found.Jawab)? found.Jawab[Math.floor(Math.random()*found.Jawab.length)] : found.Jawab;
      addMessage(jawab,"bot");
    }else{
      addMessage("‚ùì Tidak ada jawaban. Tambahkan via Edit Data.","bot");
    }
  }else{
    addMessage("‚è≥ Tunggu jawaban dari "+provider,"bot");
  }
}
document.getElementById("btnSend").onclick=()=>{
  const txt=document.getElementById("prompt").value.trim();
  if(txt){ document.getElementById("prompt").value=""; sendMessage(txt); }
};
document.getElementById("btnClear").onclick=()=>{ document.getElementById("chat").innerHTML=""; };

// init
document.getElementById("providerBadge").innerText = provider;
</script>
</body>
</html>